<html>

    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
        <title>ArcGIS Developer Guide: Facility routing</title>
        <style>
            html,
            body,
            #viewDiv {
                padding: 0;
                margin: 0;
                height: 100%;
                width: 100%;
            }
        </style>

        <link rel="stylesheet" href="https://js.arcgis.com/4.19/esri/themes/light/main.css">
        <script src="https://js.arcgis.com/4.19/"></script>

        <script>
            require([
                "esri/config",
                "esri/Map",
                "esri/views/MapView",
                "esri/Graphic",
                "esri/layers/GraphicsLayer",
                "esri/tasks/ClosestFacilityTask",
                "esri/tasks/support/ClosestFacilityParameters",
                "esri/tasks/support/FeatureSet",
                "esri/geometry/Point",
                "esri/symbols/Symbol",
                "esri/layers/FeatureLayer",
            ], (
                esriConfig,
                Map,
                MapView,
                Graphic,
                GraphicsLayer,
                ClosestFacilityTask,
                ClosestFacilityParameters,
                FeatureSet,
                Point,
                Symbol,
                FeatureLayer
            ) => {
                    
              esriConfig.apiKey = "AAPK81b7cca05fd44c15a03618aa1d5dd08bZ1H0FAlNGuWt3LBhlRWCK906HeAPjeUnUsp30Hja37HR_MwAO3BPqQO2D-rMlJTE";

              const routeSymbol = {
                type: "simple-line",
                color: [50, 150, 255, 0.75],
                width: "5",
              };

              const startSymbol = {                
                type: "simple-marker",
                color: [255, 255, 255, 1.0],
                size: 8,
                outline: {
                  color: [50, 50, 50],
                  width: 1,
                }       
              };

              const routesLayer = new GraphicsLayer();                
              let featuresetFacilities = null;

              const facilitiesFeatureLayer = new FeatureLayer({
                url: "https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/Dispensary/FeatureServer/0",
                outFields: ["*"]
              });
                                
              let map = new Map({
                basemap: "arcgis-streets",
                layers: [routesLayer, facilitiesFeatureLayer],
              });

              let view = new MapView({
                container: "viewDiv",
                map: map,
                center: [35.714843501, -3.357520155],
                zoom: 5,
                constraints: {
                  snapToZoom: false
                }
              });
              view.popup.actions = [];
              view.when(() => {                          
                // WAIT FOR FEATURE LAYER TO BE LAODED // 
                facilitiesFeatureLayer.load().then(async () => {
                  // RETRIEVE ALL FACILITIES //
                  featuresetFacilities = await facilitiesFeatureLayer.queryFeatures({where: "Admin1 = 'Bomet'"});
                  // INITIAL SOLVE // 
                  findClosestFacility(addStartGraphic(view.center));
                });
              });

              view.on("click", (event) => {
                view.hitTest(event).then((response) => {
                  if (response.results.length === 1) {
                    findClosestFacility(addStartGraphic(event.mapPoint));
                  }
                });
              });
              
              //const closestFacilityUrl = 'https://route-api.arcgis.com/arcgis/rest/services/World/ClosestFacility/NAServer/ClosestFacility_World/solveClosestFacility';
              const closestFacilityUrl = "https://route-api.arcgis.com/arcgis/rest/services/World/ClosestFacility/NAServer/ClosestFacility_World/solveClosestFacility";

              function findClosestFacility(startFeature) {

                const params = new ClosestFacilityParameters({
                  facilities: featuresetFacilities,
                  incidents: new FeatureSet({ features: [startFeature] }),
                  returnRoutes: true,
                  returnFacilities: true,
                  defaultTargetFacilityCount: 3,
                });                    

                const closestFacilityTask = new ClosestFacilityTask({url: closestFacilityUrl});
                closestFacilityTask.solve(params).then(
                  (results) => {                    
                    showRoutes(results.routes);
                    console.info(results.routes.map(route=>route.toJSON()));
                    //console.info(results.routes.map(route=>route.attributes));
                  },
                  (error) => {
                    console.error(error.details);
                  }
                );
              }                                         

              function addStartGraphic(point) {
                view.graphics.removeAll();
                const graphic = new Graphic({
                  symbol: startSymbol,
                  geometry: point,
                });
                view.graphics.add(graphic);
                return graphic;
              }

              function showRoutes(routes) {
                routesLayer.removeAll();
                routesLayer.addMany(routes.map((route) => {
                  route.symbol = routeSymbol;
                  return route;
                }));
              }
              
            });
        </script>
    </head>
    <body>
        <div id="viewDiv"></div>
    </body>
    </html>